apiVersion: v1
kind: Service
metadata:
  labels: {app: bexhoma, component: sut, configuration: default, experiment: default}
  name: bexhoma-service
spec:
  ports:
  - {port: 9091, protocol: TCP, name: port-dbms, targetPort: 4000}
  - {port: 10080, protocol: TCP, name: port-web, targetPort: 10080}
  #- {port: 9500, protocol: TCP, name: port-monitoring-application, targetPort: 8080}
  #- {port: 9300, protocol: TCP, name: port-monitoring, targetPort: 9300}
  selector: {app: bexhoma, component: sut, configuration: default, experiment: default}
---
apiVersion: v1
kind: Service
metadata:
  name: bexhoma-pd
  labels: {app: bexhoma, component: pd, configuration: default, experiment: default}
  annotations:
spec:
  ports:
  - {port: 2379, protocol: TCP, name: port-dbms, targetPort: 2379}
  - {port: 2380, protocol: TCP, name: port-web, targetPort: 2380}
  #- {port: 9300, protocol: TCP, name: port-monitoring, targetPort: 9300}
  #-- publishNotReadyAddresses: true
  clusterIP: None
  selector: {app: bexhoma, component: pd, configuration: default, experiment: default}
---
apiVersion: v1
kind: Service
metadata:
  name: bexhoma-tikv
  labels: {app: bexhoma, component: tikv, configuration: default, experiment: default}
  annotations:
spec:
  ports:
  - {port: 20160, protocol: TCP, name: port-dbms, targetPort: 20160}
  #- {port: 2380, protocol: TCP, name: port-web, targetPort: 2380}
  #- {port: 9300, protocol: TCP, name: port-monitoring, targetPort: 9300}
  #-- publishNotReadyAddresses: true
  clusterIP: None
  selector: {app: bexhoma, component: tikv, configuration: default, experiment: default}
---
# PD StatefulSet (3 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: bexhoma-pd
  labels: {app: bexhoma, component: pd, configuration: default, experiment: default}
spec:
  serviceName: bexhoma-pds
  replicas: 3
  selector:
    matchLabels:
      {app: bexhoma, component: pd, configuration: default, experiment: default}
  template:
    metadata:
      labels: {app: bexhoma, component: pd, configuration: default, experiment: default}
    spec:
      containers:
      - name: dbms
        image: pingcap/pd:v7.1.0
        args:
          # Use HOSTNAME to derive pod identity. Initial cluster must list all peers.
          - --name=$(POD_NAME)
          - --data-dir=/var/lib/pd
          - --client-urls=http://0.0.0.0:2379
          - --peer-urls=http://0.0.0.0:2380
          - --advertise-client-urls=http://$(POD_NAME).$(BEXHOMA_PD_SERVICE):2379
          - --advertise-peer-urls=http://$(POD_NAME).$(BEXHOMA_PD_SERVICE):2380
          - --initial-cluster=$(BEXHOMA_INITIAL_CLUSTER)
          #- --initial-cluster=$(BEXHOMA_pd_NAME)-0=http://$(BEXHOMA_pd_NAME)-0.$(BEXHOMA_pd_SERVICE):2380,$(BEXHOMA_pd_NAME)-1=http://$(BEXHOMA_pd_NAME)-1.$(BEXHOMA_pd_SERVICE):2380,$(BEXHOMA_pd_NAME)-2=http://$(BEXHOMA_pd_NAME)-2.$(BEXHOMA_pd_SERVICE):2380
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        ports:
          - containerPort: 2379
            name: client
          - containerPort: 2380
            name: peer
        #volumeMounts:
        #  - name: bxw
        #    mountPath: /var/lib/pd
  volumeClaimTemplates:
    - metadata:
        name: bxw
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
        # storageClassName: standard  # optional: anpassen falls n√∂tig
---
# TiKV StatefulSet (3 replicas)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: bexhoma-tikv
  labels: {app: bexhoma, component: tikv, configuration: default, experiment: default}
spec:
  serviceName: bexhoma-tikv
  replicas: 3
  selector:
    matchLabels:
      {app: bexhoma, component: tikv, configuration: default, experiment: default}
  template:
    metadata:
      labels: {app: bexhoma, component: tikv, configuration: default, experiment: default}
    spec:
      containers:
      - name: dbms
        image: pingcap/tikv:v7.1.0
        args:
          - --addr=0.0.0.0:20160
          - --advertise-addr=$(POD_NAME).$(BEXHOMA_TIKV_SERVICE):20160
          #- --advertise-status-addr=$(POD_NAME).$(BEXHOMA_TIKV_SERVICE):20180
          #- --status-addr=0.0.0.0:20180
          - --pd=$(BEXHOMA_PD_LIST)
          - --data-dir=/var/lib/tikv
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
        resources:
          limits: {cpu: 16, memory: 64Gi}
          requests: {cpu: 16, memory: 64Gi}
        ports:
          - containerPort: 20160
            name: tikv
        volumeMounts:
          - name: bxw
            mountPath: /var/lib/tikv
  volumeClaimTemplates:
  - metadata:
      name: bxw
      labels: {app: bexhoma, component: pd, configuration: default, experiment: default}
    spec:
      accessModes:
        - "ReadWriteOnce"
      resources:
        requests:
          storage: 100Gi
      storageClassName: shared
#---
#apiVersion: v1
#kind: PersistentVolumeClaim
#metadata:
#  labels: {app: bexhoma, component: sut, configuration: default, experiment: default}
#  name: bexhoma-storage
#spec:
#  accessModes:
#    - ReadWriteOnce
#  resources:
#    requests:
#      storage: 20Gi
#  storageClassName: shared
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels: {app: bexhoma, component: sut, configuration: default, experiment: default}
  name: bexhoma-deployment-tidb
spec:
  replicas: 1
  selector:
    matchLabels: {app: bexhoma, component: sut, configuration: default, experiment: default}
  template:
    metadata:
      labels: {app: bexhoma, component: sut, configuration: default, experiment: default}
    spec:
      automountServiceAccountToken: false
      imagePullSecrets:
      - {name: dockerhub}
      nodeSelector:
      tolerations:
      #- key: "nvidia.com/gpu"
      #  effect: "NoSchedule"
      containers:
      - name: dbms
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -ex;
            yum update -y;
            yum install -y mysql;
            echo "Starting TiDB..." && \
            /tidb-server --store=tikv --status=10080 --path=$(BEXHOMA_PD_LIST)
        image: pingcap/tidb:v7.1.0
        #args:
        #  - /tidb-server
        #  - --tikv=tikv
        #  - --path=$(BEXHOMA_pd_LIST)
        ports:
          - containerPort: 4000
            name: mysql
          - containerPort: 10080
            name: status
        resources:
          limits: {cpu: 100m, memory: 1Gi}
          requests: {cpu: 100m, memory: 16Gi}
        #command: ["/bin/bash"]
        #args: ["yum update -y && yum install -y mysql && /tidb-server --tikv=tikv --path=$(BEXHOMA_pd_LIST)"]
        #volumeMounts:
        #- {mountPath: /data, name: benchmark-data-volume}
        #- {mountPath: /var/lib/postgresql/data, name: benchmark-storage-volume}
      #volumes:
      #- name: benchmark-data-volume
      #  persistentVolumeClaim: {claimName: bexhoma-data}
      #- name: benchmark-storage-volume
      #  persistentVolumeClaim: {claimName: bexhoma-storage}
